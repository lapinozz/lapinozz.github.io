<!DOCTYPE html>
<html>

  <head>
  <!---
  Spaghetti Base Redesign
  -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Messing with vtables - Part II</title>
  <meta name="description" content="This second post on vtable will be consecrated to the mechanics of virtual inheritance. It will get slightly more complex, so bear with me.">
  <meta name="google-site-verification" content="WWP0tS0N_Dm8-FTd9oqyZta0oRCDYUFy24R7zSm06Vs" />
  <meta name="msvalidate.01" content="779064655F047D704FFFD2122C3591F3" />
  <link rel="stylesheet" href="/assets/css/alternative.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <link href="//cdnjs.cloudflare.com/ajax/libs/typicons/2.0.7/typicons.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/octicons/3.4.1/octicons.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
  
  <link rel="canonical" href="http://localhost:4000/learning/2016/02/08/Messing-with-vtables-part-two.html">
  <link rel="alternate" type="application/rss+xml" title="Placeholder" href="http://localhost:4000/feed.xml">


<! google analytic >
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74344870-1', 'auto');
  ga('send', 'pageview');
</script>


<! strike through >
<script>
(function() {
  function strikethrough(){
    document.body.innerHTML = document.body.innerHTML.replace(
      /\~\~(.+?)\~\~/gim,
      '<del>$1</del>'
    );
    
  }
  strikethrough();
})();
</script>

</head>


  <Body>

    <header class="site-header">
  <div class="wrapper">
<div class="pacel "><div class="pace-progress" data-progress-text="100%" data-progress="99" style="transform: translate3d(100%, 0px, 0px);">
  <div class="pace-progress-inner"></div>
</div>
<div class="pace-activity"></div></div>
  <a id="route" class="site-title" href="/">Placeholder<div style="margin: 3px 20px; font-size: 15px; float: right; white-space: pre; display:inline-block">//TODO: F̶i̶n̶d̶ ̶a̶ ̶n̶a̶m̶e̶  delete this todo</div></a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          
          
        
          
          
          <a id="route" class="page-link" href="/about.html">About</a>
          
          
        
          
          
          <a id="route" class="page-link" href="/archive.html">Archive</a>
          
          
        
          
        
          
        
          
        
          
        
          
          
          <a id="route" class="page-link" href="/project.html">Project</a>
          
          
        
          
        
          
        
          
          
          
        
          
        
          
        
          
        
        <a class="page-link" href="http://lapinozz.github.io/feed.xml"> Feeds</a>
        <a class="page-link" href="http://github.com/lapinozz?tab=repositories"><i class="typico typcn typcn-social-github" style="font-size:"></i> Repositories</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div style="margin: 4.5rem auto;">

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="inpost-header">
    <h1 class="inpost-title" itemprop="name headline">Messing with vtables - Part II</h1>
    <div style="float:right">
    <h1>
     <i class="typico typcn typcn-messages" style="    position: relative;
    top: 0px;
    font-size: 25px;"></i> <a class="disqus-comment-count" href="#disqus_thread" data-disqus-identifier="/learning/2016/02/08/Messing-with-vtables-part-two" style="color:#fff"> 0</a>
    </h1>
    
  </div>
    
   
    

 
 
  

    
    
    </p>
  
  </header>
  
  
  
  
  <div class="post-content" itemprop="articleBody">
    <p>This second post on <abbr title="virtual table">vtable</abbr> will be consecrated to the mechanics of virtual inheritance. It will get slightly more complex, so bear with me.</p>

<h1 id="disclaimer">Disclaimer</h1>
<p>Like it was said in <a href="http://localhost:4000learning/2016/02/02/Messing-with-vtables.html">part 1</a>, all of this is entirely implementation dependent, C++ has no concept of <abbr title="virtual table">vtable</abbr>. The C++ specification only provides specific behaviors that must be guaranteed and this is simply how most compilers implement it. . Using them manually is absolutely <strong><em>not portable</em></strong>. The only purpose of this code is to <del>have fun</del> learn and understand. Don’t use it for any other purpose</p>

<p>Code tested on</p>

<ul>
  <li>GCC 5.3 - Ubuntu 14.04</li>
</ul>

<h1 id="simple-inheritance">Simple Inheritance</h1>

<p>First, let’s see a simple case where virtual inheritance is needed. We have four classes, <code class="highlighter-rouge">GuiElement</code>, <code class="highlighter-rouge">Label</code>, <code class="highlighter-rouge">Clickable</code> and <code class="highlighter-rouge">Button</code>. They form an hierarchy where both <code class="highlighter-rouge">Label</code> and <code class="highlighter-rouge">Clickable</code> inherited from <code class="highlighter-rouge">GuiElement</code>. <code class="highlighter-rouge">Button</code> needs to be drawn so it inhertie from <code class="highlighter-rouge">Label</code>. It also need to be clickable so of course it also inherits from <code class="highlighter-rouge">Clickable</code>. One code worth ten thousand words right?</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">GuiElement</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Label</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GuiElement</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Clickable</span> <span class="o">:</span> <span class="k">public</span> <span class="n">GuiElement</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Button</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Label</span><span class="p">,</span> <span class="k">public</span> <span class="n">Clickable</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
<span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>And to make it even easier to visualize, UML diagram:</p>

<p align="center"><img src="http://localhost:4000/assets/image/UML_vtable_simple_inheritance.png" alt="UML_vtable_simple_inheritance" /></p>

<p>That’s not quite what we want. If we had an object <code class="highlighter-rouge">button</code> of type <code class="highlighter-rouge">Button</code> we could see that it has two member variable <code class="highlighter-rouge">id</code>, accessible by <code class="highlighter-rouge">button.Label::id</code> and <code class="highlighter-rouge">button.Clickable::id</code>. We’ll still try to understand how it work for simple inheritance. Here we can look at how our structs are organized in memory.</p>

<!-- 
<figure class="highlight"><pre><code class="language-text" data-lang="text">Label:
    GuiElement::id
    Label::a
    
Clickable:
    GuiElement::id
    Clickable::a</code></pre></figure>
 -->

<p><br /></p>

<table style="table-layout:fixed;width:40%;" align="center">
  <thead>
    <tr>
      <th style="text-align: left">Label</th>
      <th style="text-align: left">Clickable</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">GuiElement::id</td>
      <td style="text-align: left">GuiElement::id</td>
    </tr>
    <tr>
      <td style="text-align: left">Label::a</td>
      <td style="text-align: left">Clickable::b</td>
    </tr>
  </tbody>
</table>
<p><br /></p>

<p>The magic of this configuration is that you can very easily cast between <code class="highlighter-rouge">Label*</code> and <code class="highlighter-rouge">GuiElement*</code>. Just like in all the code and explanation we’ll see, <code class="highlighter-rouge">Label</code> and <code class="highlighter-rouge">Clickable</code> are equivalent. Minus the name change, the same code and concept applies to both in the exact same way. Unfortunately, it is not that simple for <code class="highlighter-rouge">Button</code>.</p>

<p><br /></p>

<table style="table-layout:fixed;width:40%;" align="center">
  <thead>
    <tr>
      <th style="text-align: left">Button</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Label::GuiElement::id</td>
    </tr>
    <tr>
      <td style="text-align: left">Label::a</td>
    </tr>
    <tr>
      <td style="text-align: left">Clickable::GuiElement::id</td>
    </tr>
    <tr>
      <td style="text-align: left">Clickable::b</td>
    </tr>
    <tr>
      <td style="text-align: left">Button::c</td>
    </tr>
  </tbody>
</table>
<p><br /></p>

<p>As you can see, we can cast with ease between <code class="highlighter-rouge">Button*</code> and <code class="highlighter-rouge">Lable*</code>.</p>

<p>To cast from <code class="highlighter-rouge">Button*</code> to <code class="highlighter-rouge">Clickable*</code> we need to adjust our pointer to point to the “<code class="highlighter-rouge">Clickable</code>” part of <code class="highlighter-rouge">Button</code>. That can be done by adding an offset to our pointer so that we are pointing to <code class="highlighter-rouge">Clickable::GuiElement::id</code>.</p>

<table style="width:40%;" align="center">
  <thead>
    <tr>
      <th style="text-align: right"> </th>
      <th style="text-align: left">Button</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"> </td>
      <td style="text-align: left">Label::GuiElement::id</td>
    </tr>
    <tr>
      <td style="text-align: right"> </td>
      <td style="text-align: left">Label::a</td>
    </tr>
    <tr>
      <td style="text-align: right">-&gt;</td>
      <td style="text-align: left">Clickable::GuiElement::id</td>
    </tr>
    <tr>
      <td style="text-align: right"> </td>
      <td style="text-align: left">Clickable::b</td>
    </tr>
    <tr>
      <td style="text-align: right"> </td>
      <td style="text-align: left">Button::c</td>
    </tr>
  </tbody>
</table>
<p><br /></p>

<p>And now we are pointing to a valid <code class="highlighter-rouge">Clickable</code> object. To cast it back to <code class="highlighter-rouge">Button*</code> we just have to remove that offset from the pointer so that we point to <code class="highlighter-rouge">Label::GuiElement::id</code> again.</p>

<p>You might want to note that you can’t do <code class="highlighter-rouge">GuiElement* guiElement = button</code>. Because <code class="highlighter-rouge">button</code> has two instance of <code class="highlighter-rouge">GuiElement</code>, the compiler wouldn’t know to which you want to refer . If I’m begin stubborn and decide to try anyway, GCC gently remind me that I’m an idiot:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">error: ‘GuiElement’ is an ambiguous base of ‘Button’</code></pre></figure>

<p>It is still possible to do it by first casting to <code class="highlighter-rouge">Label*</code> or <code class="highlighter-rouge">Clickable*</code>:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">GuiElement</span><span class="o">*</span> <span class="n">guiElementLabel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Label</span><span class="o">*</span><span class="p">)</span><span class="n">button</span><span class="p">;</span>
<span class="n">GuiElement</span><span class="o">*</span> <span class="n">guiElementClickable</span> <span class="o">=</span> <span class="p">(</span><span class="n">Clickable</span><span class="o">*</span><span class="p">)</span><span class="n">button</span><span class="p">;</span></pre></td></tr></tbody></table></code></pre></figure>

<p>And that’s pretty much it for basic inheritance, let’s dive in the core subject.</p>

<h1 id="virtual-inheritance">Virtual Inheritance</h1>

<p>So we’ve seen that in our example that, when using simple inheritance, we don’t get exactly what we wanted, we got two instances of <code class="highlighter-rouge">GuiElement</code> for each <code class="highlighter-rouge">Button</code>. That’s an issue we can fix with one magic word!</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">Label</span> <span class="o">:</span> <span class="k">virtual</span> <span class="k">public</span> <span class="n">GuiElement</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Clickable</span> <span class="o">:</span> <span class="k">virtual</span> <span class="k">public</span> <span class="n">GuiElement</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
<span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>By making <code class="highlighter-rouge">Label</code> and <code class="highlighter-rouge">Clickable</code> virtually inherit from <code class="highlighter-rouge">GuiElement</code> we get:</p>

<p align="center"><img src="http://localhost:4000/assets/image/UML_vtable_virtual_inheritance.png" alt="UML_vtable_simple_inheritance" /></p>

<p>Much better! Now our <code class="highlighter-rouge">Button</code>s only have one instance of <code class="highlighter-rouge">GuiElement</code>. This may look easier from a programmer stand point, but it makes the life harder for the compiler. And since you’re here, for you too.</p>

<p><br /></p>

<table style="table-layout:fixed;width:40%;" align="center">
  <thead>
    <tr>
      <th style="text-align: left">Button</th>
      <th style="text-align: left">Label</th>
      <th style="text-align: left">Clickable</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">vptr_Label</td>
      <td style="text-align: left"><abbr title="pointer to virtual table">vptr</abbr></td>
      <td style="text-align: left"><abbr title="pointer to virtual table">vptr</abbr></td>
    </tr>
    <tr>
      <td style="text-align: left">Label::a</td>
      <td style="text-align: left">Label::a</td>
      <td style="text-align: left">Clickable::b</td>
    </tr>
    <tr>
      <td style="text-align: left">vptr_Clickable</td>
      <td style="text-align: left">GuiElement::id</td>
      <td style="text-align: left">GuiElement::id</td>
    </tr>
    <tr>
      <td style="text-align: left">Clickable::b</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">Button::c</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">GuiElement::id</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
  </tbody>
</table>
<p><br /></p>

<p>Unexpected right? At least it was for me at first. Let’s see how it works! Note that the following code is not the actual class declaration, rather the result of compilation. it’s what the object might will look like in memory. To avoid confusion, I’ll add the sufix <code class="highlighter-rouge">_real</code> at the end of structs name. And don’t forget that this is only to give you an idea of how it work, details might change depending of the compiler.</p>

<p>First case, Label:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">Label_vtable</span>
<span class="p">{</span>
    <span class="c1">// offset are in byte
</span>    <span class="kt">int</span> <span class="n">offsetToVariable_GuiElement_id</span><span class="p">;</span> <span class="c1">//offset from the <abbr title="pointer to virtual table">vptr</abbr> to the variable
</span>    <span class="kt">int</span> <span class="n">offsetToTop</span><span class="p">;</span> <span class="c1">//offset from the <abbr title="pointer to virtual table">vptr</abbr> to the top of the class
</span>    <span class="n">type_info</span><span class="o">*</span> <span class="n">typeInfoPtr</span><span class="p">;</span> <span class="c1">//pointer to the type_info for this object
</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">Label_real</span>
<span class="p">{</span>
    <span class="n">Label_vtable</span> <span class="n"><abbr title="pointer to virtual table">vptr</abbr></span><span class="p">;</span> <span class="c1">//pointer to the <abbr title="virtual table">vtable</abbr>
</span>    <span class="kt">int</span> <span class="n">label_a</span><span class="p">;</span> <span class="c1">// member varible
</span>    <span class="kt">int</span> <span class="n">guiElement_id</span><span class="p">;</span> <span class="c1">// member variable inherited from GuiElement
</span><span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Note the arriving of a new friend, <code class="highlighter-rouge">typeInfoPtr</code>. It is used for various <abbr title="Real Time Type Info">RTTI</abbr> operations, eg: dynamic_cast, typeid.</p>

<p>When we want to access the member variable id, here represented by <code class="highlighter-rouge">guiElement_id</code>. We have to look into the <abbr title="virtual table">vtable</abbr> to see at what offset it is in the class. Assuming we have a <code class="highlighter-rouge">Label*</code> named <code class="highlighter-rouge">label</code> it would pretty much like this.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">Label_vtable</span><span class="o">*</span> <span class="n"><abbr title="virtual table">vtable</abbr></span> <span class="o">=</span> <span class="n">label</span><span class="p">.</span><span class="n"><abbr title="pointer to virtual table">vptr</abbr></span><span class="p">;</span>
<span class="kt">int8_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n"><abbr title="virtual table">vtable</abbr></span><span class="o">-&gt;</span><span class="n">OffsetToVariable_GuiElement_id</span><span class="p">;</span> <span class="c1">// the offset is in byte
</span><span class="kt">int8_t</span><span class="o">*</span> <span class="n">varaibleAddress</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int8_t</span><span class="o">*</span><span class="p">)</span><span class="n">label</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="n">id</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">varaibleAddress</span><span class="p">;</span></pre></td></tr></tbody></table></code></pre></figure>

<p>or for those that prefer really dense code.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">id</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)((</span><span class="kt">int8_t</span><span class="o">*</span><span class="p">)</span><span class="n">label</span> <span class="o">+</span> <span class="n">label</span><span class="p">.</span><span class="n"><abbr title="pointer to virtual table">vptr</abbr></span><span class="o">-&gt;</span><span class="n">OffsetToVariable_GuiElement_id</span><span class="p">);</span></pre></td></tr></tbody></table></code></pre></figure>

<p>But we didn’t initialize our <code class="highlighter-rouge">label</code> with valid offset yet! Adding a constructor to do so, we would end up with this. Note that we get a memory leak here since the <abbr title="virtual table">vtable</abbr> get allocated but never is freed.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="n">Label_real</span><span class="o">::</span><span class="n">Label_real</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// create the <abbr title="virtual table">vtable</abbr>
</span>    <span class="n"><abbr title="pointer to virtual table">vptr</abbr></span> <span class="o">=</span> <span class="k">new</span> <span class="n">Label_vtable</span><span class="p">();</span>
 
    <span class="c1">// calcualte the offset from the <abbr title="pointer to virtual table">vptr</abbr> (wich is as the top of the class) to the variable
</span>    <span class="c1">// label + offset == &amp;label-&gt;variable
</span>    <span class="n"><abbr title="pointer to virtual table">vptr</abbr></span><span class="o">-&gt;</span><span class="n">OffsetToVariable_GuiElement_id</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Label_vtable</span><span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
 
    <span class="c1">// the <abbr title="pointer to virtual table">vptr</abbr> is at the top of the class
</span>    <span class="c1">// so the offset from the <abbr title="pointer to virtual table">vptr</abbr> to the
</span>    <span class="c1">// top of the class is obviously 0
</span>    <span class="n"><abbr title="pointer to virtual table">vptr</abbr></span><span class="o">-&gt;</span><span class="n">OffsetToTop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
    <span class="c1">// theoricaly that's how we should do it but the copy constructor of type_info is private
</span>    <span class="c1">// anyway we dont actually need it for our exemple
</span>    <span class="c1">// I'll still leave it here as reference
</span>    <span class="c1">//<abbr title="pointer to virtual table">vptr</abbr>-&gt;typeInfoPtr = new type_info(typeid(Label));
</span><span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>The same applies for <code class="highlighter-rouge">Clickable</code>.</p>

<p>I hope that you’re still following and that it’s not too messy. If everything is confusing and you’re lost then it’s my fault, I apologize.</p>

<p>Now we need to understand how it works for <code class="highlighter-rouge">Button</code>, especially for casting to <code class="highlighter-rouge">Label*</code> or <code class="highlighter-rouge">Clickable*</code>.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">Button_vtable</span>
<span class="p">{</span>
    <span class="n">Label_vtable</span> <span class="n">vtable_label</span><span class="p">;</span>
    <span class="n">Clickable_vtable</span> <span class="n">vtable_clickable</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Button_real</span>
<span class="p">{</span>
    <span class="n">Label_vtable</span><span class="o">*</span> <span class="n">vptr_lable</span><span class="p">;</span> <span class="c1">//pointer to the lable <abbr title="virtual table">vtable</abbr>
</span>    <span class="kt">int</span> <span class="n">Label_a</span><span class="p">;</span> <span class="c1">// member varible inherited from Label
</span>
    <span class="n">Clickable_vtable</span><span class="o">*</span> <span class="n">vptr_clickable</span><span class="p">;</span> <span class="c1">//pointer to the clickable <abbr title="virtual table">vtable</abbr>
</span>    <span class="kt">int</span> <span class="n">Clickable_b</span><span class="p">;</span> <span class="c1">// member varible inherited from Clicackable
</span>
    <span class="kt">int</span> <span class="n">Button_c</span><span class="p">;</span> <span class="c1">// member varible
</span>
    <span class="kt">int</span> <span class="n">GuiElement_id</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// member variable inherited from GuiElement
</span><span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Do you see it? If you don’t, no worries! Here’s how it goes. We defined <code class="highlighter-rouge">Label_real</code> like this.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">Label_real</span>
<span class="p">{</span>
    <span class="n">Label_vtable</span> <span class="n"><abbr title="pointer to virtual table">vptr</abbr></span><span class="p">;</span> <span class="c1">//pointer to the <abbr title="virtual table">vtable</abbr>
</span>    <span class="kt">int</span> <span class="n">label_a</span><span class="p">;</span> <span class="c1">// member varible
</span>    <span class="kt">int</span> <span class="n">guiElement_id</span><span class="p">;</span> <span class="c1">// member variable inherited from GuiElement
</span><span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>The first two members fit perfectly in the layout of <code class="highlighter-rouge">Button</code>. For the third one, remember, it’s position is calculated from an offset located in the <abbr title="virtual table">vtable</abbr>. So we just have to adjust this offset so that it point to our <code class="highlighter-rouge">guiElement_id</code> in <code class="highlighter-rouge">Button</code>. To make it more clear(yes I’m better with code than words) here’s our beloved constructor.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="n">Button_real</span><span class="o">::</span><span class="n">Button_real</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">vptr_label</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Label_vtable</span><span class="p">();</span>

    <span class="c1">// the variable is separeted from the <abbr title="pointer to virtual table">vptr</abbr> by three int and two pointer
</span>    <span class="n">vptr_label</span><span class="o">-&gt;</span><span class="n">OffsetToVariable_GuiElement_id</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>

    <span class="c1">// this <abbr title="pointer to virtual table">vptr</abbr> is still at the top
</span>    <span class="n">vptr_label</span><span class="o">-&gt;</span><span class="n">OffsetToTop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">vptr_clickable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Clickable_vtable</span><span class="p">();</span>

    <span class="c1">// the variable is separated from the <abbr title="pointer to virtual table">vptr</abbr> by two int and one pointer
</span>    <span class="n">vptr_clickable</span><span class="o">-&gt;</span><span class="n">OffsetToVariable_GuiElement_id</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>

    <span class="c1">// this <abbr title="pointer to virtual table">vptr</abbr> is separated from the top by one int and one pointer
</span>    <span class="n">vptr_clickable</span><span class="o">-&gt;</span><span class="n">OffsetToTop</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
    
    <span class="c1">// note that the typeInfoPtr of both <abbr title="virtual table">vtable</abbr> would be pointing to
</span>    <span class="c1">// the type_info of Button 
</span><span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Now you know how it works under the hood when casting from derived class to base class (upcasting), even when virtual inheritance is involved. You can brag to your friend about it and look cool. Until they ask you about downcast… You might be tempted to say that’s it as simple as it is for non-virtual inheritance, you just have to substract the offset you added previously right? Well, no, that would be too easy wouldn’t it be?</p>

<p>To understand why, we need yet another class.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">Slider</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Label</span><span class="p">,</span> <span class="k">public</span> <span class="n">Clickable</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">e</span><span class="p">;</span>
<span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>And the obligatory UML diagram.</p>

<p align="center"><img src="http://localhost:4000/assets/image/UML_vtable_virtual_inheritance_advanced.png" alt="UML_vtable_simple_inheritance" /></p>

<p>Consider the following case. We have want to cast from <code class="highlighter-rouge">GuiElement*</code> to <code class="highlighter-rouge">Label*</code>, don’t forget it could be pointing to any of the following; <code class="highlighter-rouge">GuiElement</code>, <code class="highlighter-rouge">Label</code>, <code class="highlighter-rouge">Clickable</code>, <code class="highlighter-rouge">Button</code> or <code class="highlighter-rouge">Slider</code>. Now the problem is that <code class="highlighter-rouge">GuiElement</code> by itself carry no type information.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">GuiElement_real</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>That means it could be any of the following case 
That means that the <code class="highlighter-rouge">GuiElement</code> could be at any of those point and we have no way to know which one it is. Since we dont have <abbr title="Real Time Type Info">RTTI</abbr> we can’t know how to cast from <code class="highlighter-rouge">GuiElement*</code> to <code class="highlighter-rouge">Label*</code> because we dont know where we point relatively to the <code class="highlighter-rouge">Label</code>, and in some case there is no <code class="highlighter-rouge">Label</code>.</p>

<table style="white-space:pre" align="center">
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: left">Slider</th>
      <th style="text-align: left"> </th>
      <th style="text-align: left">Button</th>
      <th style="text-align: left"> </th>
      <th style="text-align: left">Label</th>
      <th style="text-align: left"> </th>
      <th style="text-align: left">Clickable</th>
      <th style="text-align: left"> </th>
      <th style="text-align: left">GuiElement</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"> </td>
      <td style="text-align: left">vptr_Label</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">vptr_Label</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"><abbr title="pointer to virtual table">vptr</abbr></td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"><abbr title="pointer to virtual table">vptr</abbr></td>
      <td style="text-align: left">     -&gt;</td>
      <td style="text-align: left">GuiElement::id</td>
    </tr>
    <tr>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Label::a</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Label::a</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Label::a</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Clickable::b</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left"> </td>
      <td style="text-align: left">vptr_Clickable</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">vptr_Clickable</td>
      <td style="text-align: left">     -&gt;</td>
      <td style="text-align: left">GuiElement::id</td>
      <td style="text-align: left">     -&gt;</td>
      <td style="text-align: left">GuiElement::id</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Clickable::b</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Clickable::b</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Slider::d</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Button::c</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left"> </td>
      <td style="text-align: left">Slider::e</td>
      <td style="text-align: left">     -&gt;</td>
      <td style="text-align: left">GuiElement::id</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
    <tr>
      <td style="text-align: left">-&gt;</td>
      <td style="text-align: left">GuiElement::id</td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
      <td style="text-align: left"> </td>
    </tr>
  </tbody>
</table>

<p>You can actually try it and the compiler will tell you.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="n">Label</span><span class="o">*</span> <span class="n">label</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">guiElement</span><span class="p">);</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">error: cannot dynamic_cast ‘guiElement’ (of type ‘struct GuiElement*’) to type ‘struct Label*’ (source type is not polymorphic)</code></pre></figure>

<p>As the compiler pointed out, the problem is that <code class="highlighter-rouge">GuiElement</code> is not polymorphic. The best way to fix this is to add a virtual destructor to <code class="highlighter-rouge">GuiElement</code>. Anyway, every class which gets inherited from should have a virtual destructor to ensure proper destruction of every class.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">GuiElement</span>
<span class="p">{</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">GuiElement</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Now the compiler knows that <code class="highlighter-rouge">GuiElement</code> needs a <abbr title="virtual table">vtable</abbr> and will include one. And since the <abbr title="virtual table">vtable</abbr> include <abbr title="Real Time Type Info">RTTI</abbr> (via <code class="highlighter-rouge">typeInfoPtr</code>) we will be able to perform our cast! But first, since we modified <code class="highlighter-rouge">GuiElement</code> we need to redefine <code class="highlighter-rouge">Button_real</code> and <code class="highlighter-rouge">Button_vtable</code>.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">Button_vtable</span>
<span class="p">{</span>
    <span class="n">Label_vtable</span> <span class="n">vtable_label</span><span class="p">;</span>
    <span class="n">Clickable_vtable</span> <span class="n">vtable_clickable</span><span class="p">;</span>
    <span class="n">GuiElement_vtable</span> <span class="n">vtable_guiElement</span><span class="p">;</span>
    
    <span class="c1">//here would also be a function pointer to the virtual destructor 
</span>    <span class="c1">//~GuiElement()
</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">Button_real</span>
<span class="p">{</span>
    <span class="n">Label_vtable</span><span class="o">*</span> <span class="n">vptr_lable</span><span class="p">;</span> <span class="c1">//pointer to the lable <abbr title="virtual table">vtable</abbr>
</span>    <span class="kt">int</span> <span class="n">Label_a</span><span class="p">;</span> <span class="c1">// member varible inherited from Label
</span>
    <span class="n">Clickable_vtable</span><span class="o">*</span> <span class="n">vptr_clickable</span><span class="p">;</span> <span class="c1">//pointer to the clickable <abbr title="virtual table">vtable</abbr>
</span>    <span class="kt">int</span> <span class="n">Clickable_b</span><span class="p">;</span> <span class="c1">// member varible inherited from Clicackable
</span>
    <span class="kt">int</span> <span class="n">Button_c</span><span class="p">;</span> <span class="c1">// member varible
</span>
    <span class="n">GuiElement_vtable</span><span class="o">*</span> <span class="n">vptr_guiElement</span><span class="p">;</span> <span class="c1">//pointer to the guiElement <abbr title="virtual table">vtable</abbr>
</span>    <span class="kt">int</span> <span class="n">GuiElement_id</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// member variable inherited from GuiElement
</span><span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>From all the information here you should be able to work out what <code class="highlighter-rouge">GuiElement_vtable</code> looks like. Of course <code class="highlighter-rouge">vptr_guiElement</code> need to be added to <code class="highlighter-rouge">Lable_real</code> and <code class="highlighter-rouge">Clickable_real</code>. And every constructor need to be updated so that they give the correct offset.</p>

<p>One last point, you might wonder what’s <code class="highlighter-rouge">offsetToTop</code> doing in vtables. It’s used when casting to <code class="highlighter-rouge">void*</code> so that you can simply substract the pointer by the offset to get the base of the most derived class.</p>

<p><br />
<br /></p>

<p>And that’s pretty much it. I hope it was clear enough. If you have any suggestion or question, feel free to comment in the box below or to contact me directly.</p>


  </div>



<div class="arrowNav">
 
 
<div class="arrowLeft">
<a id="route" class="tooltip-right" href="/project/2016/03/27/generating-brainfuck-code-using-genetic-algorithm.html" title="
&lt;p class=hoveratas&gt;Generating brainfuck code using genetic algorithm&lt;/p&gt; &lt;p class=hoverbawah&gt;This is a project inspired by [this one] It use...&lt;/p&gt;
"><i class="typcn typcn-chevron-left" style="    font-size: 30px;
    position: relative;
   
    "></i></a>
</div>


 
<div class="arrowRight" style="float:right">
<a id="route" class="tooltip-left" href="/learning/2016/02/02/Messing-with-vtables.html" title="
&lt;p class=hoveratas&gt;Messing with vtables - Part I&lt;/p&gt; &lt;p class=hoverbawah&gt;This is an article about vtable. Even if in practice...&lt;/p&gt;
"><i class="typcn typcn-chevron-right" style="    font-size: 30px;
    position: relative;
   
    "></i></a>
</div>

</div>


  <p class="post-meta" style="    background: #00bc8c;
    padding: 15px 0px 15px 20px;"><time datetime="2016-02-08T22:47:08-05:00" itemprop="datePublished"><i class="typcn typcn-calendar-outline"></i> Feb 8, 2016</time> 
    |
  
  <a href="/tags/#vtable" style="color: #fff;"><i class="typcn typcn-tags"></i> vtable</a>
  
  <a href="/tags/#C++" style="color: #fff;"><i class="typcn typcn-tags"></i> C++</a>
  
  
  

</article>





<style>
    #disqus_thread {
  overflow: hidden;

  iframe {
    margin-bottom: -54px;
  }
}
</style>

<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
		this.page.url = 'http://localhost:4000/learning/2016/02/08/Messing-with-vtables-part-two';
		this.page.identifier = '/learning/2016/02/08/Messing-with-vtables-part-two';
	};
    
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//theplaceholder.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <h2 class="footer-heading">Placeholder</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Lapinozz Thech Blog</li>
          <li><a href="mailto:monstrefou@gmail.com">monstrefou@gmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/lapinozz"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">lapinozz</span></a>

          </li>
          
          
          

          
        </ul>
      </div>
      <div class="footer-col footer-col-3">
        <p>Designed by Spaghetti</p>
        <p>Proudly hosted by <a href="https://pages.github.com/" target="_blank"><span class="octicon octicon-logo-github" style="color: #828282;
    position: relative;
    top: 4px;
    left: 3px;
    font-size: 20px;"></span></a></p>
      </div>
    </div>
  </div>
</footer>
<!--- Where Javascript Loaded --->
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script type="text/javascript" src="http://iamceege.github.io/tooltipster/js/jquery.tooltipster.js"></script>
<script>
$(document).ready(function() {
	if(location.pathname != "/") {
		$('.trigger a[href^="/' + location.pathname.split("/")[1] + '"]').addClass('active');
	} else $('.none a:eq(0)').addClass('active');
});

</script>
  <script>
        $(document).ready(function() {
            $('.tooltip-right').tooltipster({
                contentAsHTML: true,
                position: 'right',
            });
        });
        $(document).ready(function() {
            $('.tooltip-left').tooltipster({
                contentAsHTML: true,
                position: 'left',
            });
        });

        document.body.innerHTML = document.body.innerHTML.replace(
          /\’/gim,
          '\''
        );
    </script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery.pjax/1.9.6/jquery.pjax.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery-autocomplete.js"></script>
<script src="/assets/js/responsive_waterfall.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>
<script>


$(document).ready(function(){$(".menu-icon").click(function(){$(".trigger").toggle()})}),$(function(){$(document).pjax("#route","body",{fragment:"body",timeout:1e5,scrollTo:0,push:!0,maxCacheLength:20,replace:!1})}),$(document).on("pjax:error",function(e,n,t,o,c){return c.success(n.responseText,t,n),!1});var options={url:"/gblk.json",getValue:"title",list:{match:{enabled:!0,maxNumberOfElements:5}},template:{type:"links",fields:{link:"url"}},theme:"square"};$("#countries").easyAutocomplete(options),Pace.on("start",function(){$(".pacel").show()}),Pace.on("done",function(){$(".pacel").hide()}),$(function(){$("img").lazyload({})});var waterfall=new Waterfall({containerSelector:".wf-container",boxSelector:".wf-box",minBoxWidth:180});$(document).ready(function(){$(".menu-icon").click(function(){$(".trigger").toggle()})});
       
</script>
<script id="dsq-count-scr" src="//theplaceholder.disqus.com/count.js" async></script>


  </Body>

</html>
